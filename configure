#!/bin/bash

QMAKE=qmake
MAKE=make
WHICH=which

QT_VERSION="5"
NURIA_MODULES="core network"

# Directory paths
SOURCE_TREE=`readlink -f $(dirname $0)`
BUILD_TREE=`pwd`

mkdir -p $BUILD_TREE/features

# 
QMAKE_CACHE=$BUILD_TREE/.qmake.cache
NURIA_VARS=$BUILD_TREE/features/nuriavars.prf

# Default variables
CLANG="$(which clang++)"
LLVM_CONFIG="$(which llvm-config)"
CMAKE="$(which cmake)"
PREFIX="/usr"
BINDIR="bin"
LIBSDIR="lib"
HEADERSDIR="include"
FEATURESDIR="lib/qt/mkspecs/features"
PREFIX_SET=0
BINDIR_SET=0
LIBSDIR_SET=0
HEADERSDIR_SET=0
FEATURESDIR_SET=0
LDFLAGS=""
CFLAGS=""
Release=1

# Help?
if [ "$1" == "-h" ] || [ "$1" == "-help" ] || [ "$1" == "--help" ]; then
	
	echo "Usage: configure [-prefix <path>] [-libdir <path>] [-bindir <path>]"
	echo "       [-headerdir <path>] [-featuredir <path> ]"
	echo "       [-qmake-bin <path>] [-cmake-bin <path>] [-make-bin <path>]"
	echo "       [-debug|-release] [-no-<module>]"
	echo "       [-clang-bin <path>] [-llvm-config-bin <path>]"
	echo 
	echo "-prefix <path>     Relative install path."
	echo "                   Default: $PREFIX"
	echo "-libdir <path>     Library sub-directory"
	echo "                   Default: PREFIX/$LIBSDIR"
	echo "-bindir <path>     Executables sub-directory"
	echo "                   Default: PREFIX/$BINDIR"
	echo "-headerdir <path>  Headers sub-directory"
	echo "                   Default: PREFIX/$HEADERSDIR"
	echo "-featuredir <path> QMake feature file directory path"
	echo "                   Default: PREFIX/$FEATURESDIR"
	echo "-qmake-bin <path>  Path to the qmake binary"
	echo "-cmake-bin <path>  Path to the cmake binary (Default: $CMAKE)"
	echo "-cmake-bin <path>  Path to the cmake binary"
	echo "-make-bin <path>   Path to the make binary"
	echo "-debug             Build library in debug mode"
	echo "-release           Build library in release mode"
	echo "-clang-bin <path>  Path to clang++ (Default: $CLANG)"
	echo "-llvm-config-bin <path> Path to llvm-config (Default: $LLVM_CONFIG)"
	echo "-no-tria           Do not build Tria"
	echo "-no-network        Do not build the Network module"
	echo
	echo "Note: The NuriaFramework is compatible with Qt5.x"
	echo "      The Qt version as used by qmake will be used to build."
	
	exit
fi

# Init nuriavars.prf
echo "# NuriaVars.prf - part of the NuriaFramework." > $NURIA_VARS
echo "# Generated at $(date)" >> $NURIA_VARS
echo "NURIA_MODULES = $NURIA_MODULES" >> $NURIA_VARS

# Parse arguments
while (( $# > 0 )); do
    if [ $1 == "-qmake-bin" ]; then
        QMAKE=$2
        shift
    elif [ $1 == "-make-bin" ]; then
        MAKE=$2
        shift
    elif [ $1 == "-L" ]; then
        echo "LIBS += -L$2" >> $QMAKE_CACHE
        shift
    elif [ $1 == "-l" ]; then
        echo "LIBS += -l$2" >> $QMAKE_CACHE
        shift
    elif [ $1 == "-I" ]; then
        echo "INCLUDEPATH += $2" >> $QMAKE_CACHE
        shift
    elif [ $1 == "-no-network" ]; then
        echo "NURIA_MODULES -= network" >> $QMAKE_CACHE
        echo "NURIA_MODULES -= network" >> $NURIA_VARS
    elif [ $1 == "-prefix" ]; then
        PREFIX="$2"; shift
        PREFIX_SET=1
    elif [ $1 == "-bindir" ]; then
        BINDIR="$2"; shift
        BINDIR_SET=1
    elif [ $1 == "-libdir" ]; then
        LIBSDIR="$2"; shift
        LIBSDIR_SET=1
    elif [ $1 == "-headerdir" ]; then
        HEADERSDIR="$2"; shift
        HEADERSDIR_SET=1
    elif [ $1 == "-featuredir" ]; then
        FEATURESDIR="$2"; shift
        FEATURESDIR_SET=1
    elif [ $1 == "-debug" ]; then
        echo "CONFIG += debug" >> $QMAKE_CACHE
        Release=0
    elif [ $1 == "-release" ]; then
        echo "CONFIG += release" >> $QMAKE_CACHE
        Release=1
    elif [ $1 == "-clang-bin" ];  then
        CLANG="$2"
        shift
    elif [ $1 == "-llvm-config-bin" ];  then
        LLVM_CONFIG="$2"
        shift
    elif [ $1 == "-cmake-bin" ];  then
        CMAKE="$2"
        shift
    elif [ $1 == "-no-tria" ];  then
        CLANG=""
        LLVM_CONFIG=""
    elif [ $1 == "-no-js" ]; then
        echo "NO_JAVASCRIPT = 1" >> $QMAKE_CACHE
    else
        echo "Unrecognized configure option: $1"
        exit 2
    fi
    shift
done

# Detect QMake settings. 
if [ ! -f "$($WHICH $QMAKE)" ]; then
	echo "Error: QMake binary (${QMAKE}) not found - Abort."
	exit 3
fi

# Check Qt version
Version="$($QMAKE -query QT_VERSION)"

if [ "${Version:0:1}" == "4" ]; then
	echo "Sorry, no support for Qt4!"
	exit 2
elif [ "${Version:0:1}" == "5" ]; then
	QT_VERSION="5"
else
	echo "Error: Unknown Qt version $Version - Abort."
	exit 1
fi

# 
function pathHelper() {
	VarName="$1"
	CurrentVal="$2"
	IsSet="$3"
	Suffix="$4"
	
	if [ "$IsSet" == 0 ] && [ -n "$VarName" ]; then
		
		if [ -n "$Suffix" ]; then
			echo "$($QMAKE -query "$VarName")/$Suffix"
		else
			echo $($QMAKE -query "$VarName")
		fi
		
		# Is current val a valid absolute path?
	elif [ "$(readlink -f "$CurrentVal")" == "$CurrentVal" ]; then
		echo "$CurrentVal"
		
		# Prefix?
	elif [ -d "${PREFIX}/${CurrentVal}" ]; then
		echo "${PREFIX}/${CurrentVal}"
	else
		echo "Error: Neither \"${PREFIX}/${CurrentVal}\" nor \"${CurrentVal}\" exist - Abort." 1>&2
		exit 3
	fi
	
}

function checkPath() {
	if [ "$?" == 3 ]; then
		echo $*
		exit 3
	fi
	
}

# Query paths
[ "$PREFIX_SET" == 0 ] && PREFIX="$($QMAKE -query QT_INSTALL_PREFIX)"
BINDIR="$(pathHelper "" "$BINDIR" $BINDIR_SET)"
checkPath $BINDIR

LIBSDIR="$(pathHelper QT_INSTALL_LIBS "$LIBSDIR" $LIBSDIR_SET)"
checkPath $LIBSDIR

HEADERSDIR="$(pathHelper QT_INSTALL_PREFIX "$HEADERSDIR" $HEADERSDIR_SET "include")"
checkPath $HEADERSDIR

FEATURESDIR="$(pathHelper QT_INSTALL_DATA "$FEATURESDIR" $FEATURESDIR_SET "mkspecs/features")"
checkPath $FEATURESDIR

# Okay, output some data
echo -n "Configured NuriaFramework, linking to Qt${QT_VERSION} (${Version})"
if [ "$Release" == 1 ]; then
	echo " - Release build"
	echo "NURIA_INSTALL_MODE = release" >> $NURIA_VARS
else
	echo " - Debug build"
	echo "NURIA_INSTALL_MODE = debug" >> $NURIA_VARS
fi

# Write the features file 'nuriavars.prf'
echo "NURIA_INSTALL_PREFIX = $PREFIX" >> $NURIA_VARS
echo "NURIA_INSTALL_LIBS = $LIBSDIR" >> $NURIA_VARS
echo "NURIA_INSTALL_HEADERS = $HEADERSDIR" >> $NURIA_VARS
echo "NURIA_INSTALL_FEATURES = $FEATURESDIR" >> $NURIA_VARS

# 
echo "INCDIR=${BUILD_TREE}/include" >> $QMAKE_CACHE

# Create directories
mkdir -p lib
mkdir -p bin
mkdir -p include
mkdir -p include/nuria
cp -f ${SOURCE_TREE}/features/nuria.prf features/

# Helper project file
echo "include(features/nuriavars.prf)" > .helper.pro
echo 'error($$NURIA_MODULES)' >> .helper.pro

Modules="$($QMAKE .helper.pro 2>&1|sed -e 's/^[^:]*://;s/ ./\U&\E/g')"
rm .helper.pro

# Run qmake for every to-be-build module in their own sub-directory
for i in $Modules; do
	mkdir $i; cd $i
	cp $QMAKE_CACHE .
	$QMAKE ${SOURCE_TREE}/${i}
	cd ..
done

# Write a simple Makefile
echo "# Makefile for the NuriaFramework" > Makefile
echo "# Generated at $(date)" >> Makefile
echo "# Configured modules: $Modules" >> Makefile
echo "# Install prefix: $PREFIX" >> Makefile
echo "" >> Makefile
echo "MAKE ?= $MAKE" >> Makefile
echo "COPY ?= cp" >> Makefile
echo "BINDIR ?= $BINDIR" >> Makefile
echo "LIBDIR ?= $LIBSDIR" >> Makefile
echo "INCDIR ?= $HEADERSDIR" >> Makefile
echo "FEATUREDIR ?= $FEATURESDIR" >> Makefile
echo "" >> Makefile
echo "all: build" >> Makefile
echo "" >> Makefile

for i in $Modules; do
	echo ".PHONY: $i" >> Makefile
	echo "${i}:" >> Makefile
	echo "	\$(MAKE) -C $i \$(MAKECMDGOALS)" >> Makefile
	echo "	\$(MAKE) -C $i install" >> Makefile
	echo "" >> Makefile
done

# Tria special-case
if [ -f "$CLANG" ] && [ -f "$LLVM_CONFIG" ] && [ -f "$CMAKE" ]; then
	# Run CMAKE on Tria
	mkdir Tria
	cd Tria
	$CMAKE ${SOURCE_TREE}/Tria -DCMAKE_CXX_COMPILER="$CLANG" \
		-DLLVM_CONFIG_EXECUTABLE="$LLVM_CONFIG"
	cd ..
	
	if [ $? != 0 ]; then
		echo "** Failed to run cmake! Aborting ..."
		exit 2
	fi
	
	# Write makefile part
	echo ".PHONY: Tria" >> Makefile
	echo "Tria:" >> Makefile
	echo "	\$(MAKE) -C Tria \$(MAKECMDGOALS)" >> Makefile
	echo "	\$(MAKE) -C Tria install" >> Makefile
	echo "" >> Makefile
	
	Modules="Tria $Modules"
	echo "NURIA_MODULES += tria" >> $NURIA_VARS
	echo "TRIA_BIN = $BINDIR/tria" >> $NURIA_VARS
else
	echo "Tria has been disabled - You won't be able to use the meta system of the Framework!"
fi

echo "build:${Modules}" >> Makefile
echo "clean:${Modules}" >> Makefile
echo ".PHONY: install" >> Makefile
echo "install:" >> Makefile
echo '	$(COPY) lib/* $(LIBDIR)' >> Makefile
echo '	$(COPY) -r include/nuria $(INCDIR)' >> Makefile
echo '	$(COPY) features/*.prf $(FEATUREDIR)' >> Makefile
echo '	$(COPY) bin/tria $(BINDIR)' >> Makefile

# Done!
echo "Now run $MAKE to start the build process!"
